<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KalshiWhale - Crypto Whale Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --brand-primary: #1AAE6F;
            --brand-deep: #0B8A4A;
            --brand-light: #EAF6F0;
            --brand-border: #E8EDE9;
            --border-radius: 14px;
            --shadow-green-soft: 0 6px 18px rgba(26, 174, 111, 0.10);
            --shadow-green-inner: inset 0 0 0 1px rgba(11, 138, 74, 0.10);
            --brand-grad: linear-gradient(135deg, #1AAE6F 0%, #0B8A4A 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #ffffff;
            color: var(--brand-deep);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Header Styles */
        .header {
            padding: 32px 0 24px 0;
            text-align: center;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .logo {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo svg {
            fill: var(--brand-primary);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--brand-deep);
            margin: 0;
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--brand-deep);
            opacity: 0.8;
            margin-bottom: 20px;
            text-align: center;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn-primary {
            padding: 10px 16px;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-deep) 100%);
            color: white;
            border: none;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(26, 174, 111, 0.10);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(26, 174, 111, 0.15);
        }

        /* KPI Row */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 6px 18px rgba(26, 174, 111, 0.10), inset 0 0 0 1px rgba(11, 138, 74, 0.10);
            border: 1px solid var(--brand-border);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            background: var(--brand-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--brand-deep);
            font-size: 16px;
        }

        .kpi-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--brand-deep);
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .kpi-content p {
            font-size: 0.875rem;
            color: var(--brand-deep);
            opacity: 0.8;
        }

        .live-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .live-indicator {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse-ring {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--brand-primary);
            animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
            opacity: 0.75;
        }

        .pulse-dot {
            position: relative;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(26, 174, 111, 0.25);
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            80%, 100% {
                opacity: 0;
            }
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .main-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 6px 18px rgba(26, 174, 111, 0.10);
            border: 1px solid var(--brand-border);
            padding: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--brand-deep);
            letter-spacing: -0.01em;
        }

        /* Insights Section */
        .insight-card {
            border-radius: var(--border-radius);
            padding: 16px;
            border: 1px solid rgba(26, 174, 111, 0.35);
            background: white;
            box-shadow: 0 8px 18px rgba(26, 174, 111, 0.08);
            margin-bottom: 16px;
        }

        .insight-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .just-in-badge {
            padding: 6px 10px;
            border-radius: 20px;
            background: var(--brand-light);
            color: var(--brand-deep);
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .insight-content h4 {
            font-weight: 600;
            color: var(--brand-deep);
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .insight-content p {
            font-size: 0.875rem;
            color: var(--brand-deep);
            opacity: 0.8;
        }

        /* Markets Table */
        .markets-table {
            width: 100%;
            border-collapse: collapse;
        }

        .markets-table th,
        .markets-table td {
            padding: 12px 0;
            text-align: left;
            border-bottom: 1px solid var(--brand-border);
        }

        .markets-table th:last-child,
        .markets-table td:last-child {
            text-align: right;
        }

        .market-row:last-child td {
            border-bottom: none;
        }

        .market-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .market-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--brand-light) 0%, white 100%);
            flex-shrink: 0;
        }

        .market-details {
            min-width: 0;
        }

        .market-pair {
            font-weight: 500;
            color: var(--brand-deep);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .market-type {
            font-size: 0.75rem;
            color: var(--brand-deep);
            opacity: 0.7;
        }

        .market-stats {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sparkline {
            width: 72px;
            height: 24px;
            opacity: 0.8;
        }

        .market-value {
            font-weight: 600;
            color: var(--brand-deep);
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        /* Whale Alerts (Full Width) */
        .whale-alerts {
            grid-column: 1 / -1;
        }

        /* Whale Alert Severity Styles */
        .alert-high {
            background: linear-gradient(135deg, #ffe6e6 0%, #fff0f0 100%);
            border-left: 4px solid #e74c3c;
        }

        .alert-medium {
            background: linear-gradient(135deg, #fff8e6 0%, #fefcf5 100%);
            border-left: 4px solid #f39c12;
        }

        .alert-low {
            background: linear-gradient(135deg, #e6f7ff 0%, #f0fbff 100%);
            border-left: 4px solid #3498db;
        }

        /* Whale alert types with specific styling */
        .alert-volume-surge {
            border-left: 4px solid #e74c3c;
        }

        .alert-odds-flip {
            border-left: 4px solid #f39c12;
        }

        .alert-order-book-shift {
            border-left: 4px solid #3498db;
        }

        .alert-high-volume {
            border-left: 4px solid #1AAE6F;
        }

        /* Footer */
        .footer {
            max-width: 1280px;
            margin: 0 auto;
            padding: 40px 24px 0;
            text-align: center;
            font-size: 0.75rem;
            color: var(--brand-deep);
            opacity: 0.6;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .kpi-row {
                grid-template-columns: 1fr;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .markets-table {
                font-size: 0.875rem;
            }
        }

        /* Loading Animation */
        .loading {
            opacity: 0.6;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 16px;
        }

        /* Hide default Chart.js styles */
        canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        /* Section Title Row with Filters */
        .section-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .filter-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-select {
            padding: 8px 16px;
            border: 1px solid var(--brand-border);
            border-radius: 8px;
            background: white;
            color: var(--brand-deep);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(26, 174, 111, 0.1);
        }

        .refresh-btn {
            padding: 8px;
            border: 1px solid var(--brand-border);
            border-radius: 8px;
            background: white;
            color: var(--brand-deep);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        /* Market Cards Layout */
        .markets-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .market-card {
            background: white;
            border: 1px solid var(--brand-border);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow-green-soft), var(--shadow-green-inner);
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .market-card:hover {
            box-shadow: 0 8px 25px rgba(26, 174, 111, 0.15), var(--shadow-green-inner);
            transform: translateY(-2px);
        }

        .market-card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .market-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: var(--brand-light);
            color: var(--brand-deep);
            font-weight: bold;
            font-size: 14px;
        }

        .market-content {
            flex: 1;
            min-width: 0;
        }

        .market-question {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--brand-deep);
            margin-bottom: 8px;
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .trending-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            background: var(--brand-light);
            color: var(--brand-deep);
            font-weight: 500;
        }

        .trending-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--brand-primary);
        }

        .outcome-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--brand-light);
        }

        .outcome-item:last-child {
            border-bottom: none;
        }

        .outcome-text {
            font-size: 0.875rem;
            color: var(--brand-deep);
            opacity: 0.9;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .outcome-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .probability {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--brand-deep);
            font-variant-numeric: tabular-nums;
        }

        .bet-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bet-pill {
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .bet-pill.yes {
            background: linear-gradient(135deg, #7DD3FC, #A78BFA);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .bet-pill.no {
            background: linear-gradient(135deg, #E9ECEF, #E9ECEF);
            color: var(--brand-deep);
        }

        .bet-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .market-footer {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.75rem;
            color: var(--brand-deep);
            opacity: 0.7;
        }

        .volume-info {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-info {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .expand-btn {
            margin-left: auto;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--brand-border);
            background: white;
            color: var(--brand-deep);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }

        .expand-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        /* Sparkline Component */
        .sparkline {
            opacity: 0.8;
        }

        .sparkline svg {
            width: 72px;
            height: 24px;
        }

        .sparkline path {
            fill: none;
            stroke: var(--brand-primary);
            stroke-width: 2;
            stroke-linejoin: round;
            stroke-linecap: round;
        }

        /* Additional spacing utilities */
        .space-y-2 > * + * {
            margin-top: 8px;
        }

        /* KPI Cards styling to match React design */
        .kpi-card {
            background: white;
            border: 1px solid var(--brand-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-green-soft), var(--shadow-green-inner);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            background: var(--brand-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--brand-deep);
            font-weight: bold;
            font-size: 14px;
        }

        /* Live status indicator */
        .live-status {
            position: relative;
        }

        .pulse-ring {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--brand-primary);
            opacity: 0.75;
            animation: pulse 2s infinite;
        }

        .pulse-dot {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--brand-primary);
            border: 3px solid var(--brand-light);
            box-shadow: 0 0 0 3px rgba(26, 174, 111, 0.25);
        }

        @keyframes pulse {
            0% {
                transform: translateY(-50%) scale(1);
                opacity: 0.75;
            }
            50% {
                transform: translateY(-50%) scale(1.5);
                opacity: 0;
            }
            100% {
                transform: translateY(-50%) scale(1);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .section-title-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .filter-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .market-card {
                padding: 16px;
            }
            
            .market-card-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 8px;
            }
            
            .outcome-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .outcome-section {
                align-self: stretch;
                justify-content: space-between;
            }
            
            .market-footer {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .market-question {
                font-size: 0.875rem;
            }
            
            .outcome-text {
                font-size: 0.75rem;
            }
            
            .bet-button-group {
                transform: scale(0.9);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path d="M4 10c0 4.418 3.582 8 8 8 4.418 0 8-3.582 8-8v-.5a.5.5 0 0 0-.5-.5h-2.2c-1.7 0-3.083-1.383-3.083-3.083V5.5a.5.5 0 0 0-.5-.5C9.582 5 6 8.582 6 13v.5"/>
                    </svg>
                </div>
                <h1>KalshiWhale</h1>
            </div>
            <p class="header-subtitle">Real-time Crypto Whale Tracker for Kalshi Prediction Markets</p>
            <div class="header-buttons">
                <button class="btn-primary" onclick="refreshData()">Refresh Data</button>
            </div>
        </header>

        <!-- KPI Row -->
        <section class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-icon">‚Çø</div>
                <div class="kpi-content">
                    <h3 id="total-markets">0</h3>
                    <p>Total Markets</p>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">24h</div>
                <div class="kpi-content">
                    <h3 id="volume-24h">$0</h3>
                    <p>24h Volume</p>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üêã</div>
                <div class="kpi-content">
                    <h3 id="whale-alerts">0</h3>
                    <p>Whale Alerts</p>
                </div>
            </div>
            <div class="kpi-card live-status">
                <div>
                    <h3>Live Status</h3>
                    <p>Websocket</p>
                </div>
                <div class="live-indicator">
                    <span class="pulse-ring"></span>
                    <span class="pulse-dot"></span>
                </div>
            </div>
        </section>

        <!-- Main Grid -->
        <main class="main-grid">
            <!-- Insights -->
            <div class="main-section">
                <div class="section-header">
                    <h2 class="section-title">Insights</h2>
                </div>
                
                <div class="insight-card">
                    <div class="insight-header">
                        <span class="just-in-badge">JUST IN</span>
                        <div class="insight-content">
                            <h4>Fed's Goolsbee says there is still a "golden path" for the US economy</h4>
                            <p>67% chance of 3 rate cuts in 2025</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Markets -->
            <!-- Top 5 Markets with Card Layout -->
            <div class="main-section">
                <div class="section-header">
                    <div class="section-title-row">
                        <h2 class="section-title">Top 5 Kalshi Prediction Markets</h2>
                        <div class="filter-controls">
                            <select id="market-filter" class="filter-select" onchange="filterMarkets()">
                                <option value="all">All Markets</option>
                                <option value="volume">High Volume</option>
                                <option value="trending">Trending</option>
                                <option value="liquidity">High Liquidity</option>
                                <option value="recent">Recently Active</option>
                            </select>
                            <button class="refresh-btn" onclick="refreshMarketData()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M21 5v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="markets-cards" id="markets-cards">
                    <!-- Market cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Whale Alerts (Full Width) -->
            <div class="main-section whale-alerts">
                <div class="section-header">
                    <h2 class="section-title">Whale Alerts</h2>
                </div>
                <div id="whale-alerts-content" style="color: var(--brand-deep); opacity: 0.7;">
                    Loading alerts...
                </div>
            </div>
        </main>

        <footer class="footer">
            ¬© <span id="current-year"></span> KalshiWhale ‚Äî White & Green Edition
        </footer>
    </div>

    <script>
        // Set current year
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Backend API Configuration
        const API_BASE = '';
        const WS_URL = window.location.origin.replace('http', 'ws') + '/ws';

        // Data storage
        let marketsData = [];
        let charts = {};
        let websocket = null;
        let isConnected = false;

        // Initialize app
        async function init() {
            await fetchAndUpdateData();
            createCharts();
            connectWebSocket();
            startAutoRefresh();
            loadWhaleAnalytics();
            loadMarketCards();
        }

        // Fetch data from backend API
        async function fetchAndUpdateData() {
            try {
                showLoading(true);
                
                // Fetch markets data from backend
                const response = await fetch(`${API_BASE}/api/markets`);
                const data = await response.json();
                
                // Process data
                marketsData = data.markets || [];
                updateKPIs(marketsData);
                updateTopMarkets(marketsData.slice(0, 5));
                await updateWhaleAlerts(marketsData);
                loadWhaleAnalytics();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showLoading(false);
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            try {
                websocket = new WebSocket(WS_URL);
                
                websocket.onopen = function(event) {
                    console.log('WebSocket connected');
                    isConnected = true;
                    updateConnectionStatus(true);
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket disconnected');
                    isConnected = false;
                    updateConnectionStatus(false);
                    // Attempt to reconnect after 5 seconds
                    setTimeout(connectWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    isConnected = false;
                    updateConnectionStatus(false);
                };
                
            } catch (error) {
                console.error('Error connecting WebSocket:', error);
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'market_update':
                    marketsData = data.data.markets || [];
                    updateKPIs(marketsData);
                    updateTopMarkets(marketsData.slice(0, 5));
                    updateWhaleAlerts(marketsData);
                    break;
                    
                case 'whale_alerts':
                    // Handle real-time whale alerts
                    console.log('üêã Real-time whale alerts:', data.data.alerts);
                    updateWhaleAlerts(marketsData); // Refresh whale alerts display
                    break;
                    
                case 'initial_data':
                    marketsData = data.data.markets || [];
                    updateKPIs(marketsData);
                    updateTopMarkets(marketsData.slice(0, 5));
                    updateWhaleAlerts(marketsData);
                    break;
                    
                case 'heartbeat':
                    // Keep connection alive
                    break;
                    
                default:
                    console.log('Unknown message type:', data.type);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const pulseDot = document.querySelector('.pulse-dot');
            const pulseRing = document.querySelector('.pulse-ring');
            
            if (connected) {
                pulseDot.style.backgroundColor = '#1AAE6F';
                pulseRing.style.backgroundColor = '#1AAE6F';
            } else {
                pulseDot.style.backgroundColor = '#ff6b6b';
                pulseRing.style.backgroundColor = '#ff6b6b';
            }
        }

        // Update KPI cards
        function updateKPIs(markets) {
            document.getElementById('total-markets').textContent = markets.length;
            
            // Calculate total volume (placeholder calculation)
            const totalVolume = markets.length * 1250000; // Estimated volume
            document.getElementById('volume-24h').textContent = 
                '$' + (totalVolume / 1000000).toFixed(1) + 'M';
            
            // Update whale alerts (high activity markets)
            const whaleAlerts = markets.filter(market => 
                market.volume && market.volume > 1000000
            ).length;
            document.getElementById('whale-alerts').textContent = whaleAlerts;
        }

        // Update top markets table
        function updateTopMarkets(markets) {
            const table = document.querySelector('.markets-table');
            const rows = table.querySelectorAll('.market-row');
            
            markets.forEach((market, index) => {
                if (rows[index]) {
                    const pair = market.ticker_symbol || 'Unknown';
                    const value = market.volume ? 
                        '$' + (market.volume / 1000000).toFixed(1) + 'M' : 
                        '$0';
                    
                    const pairElement = rows[index].querySelector('.market-pair');
                    const valueElement = rows[index].querySelector('.market-value');
                    
                    if (pairElement) pairElement.textContent = pair + ' / USD';
                    if (valueElement) valueElement.textContent = value;
                }
            });
        }

        // Update whale alerts section with sophisticated detection
        async function updateWhaleAlerts(markets) {
            const alertsContainer = document.getElementById('whale-alerts-content');
            
            try {
                // Fetch sophisticated whale alerts from backend
                const response = await fetch('/api/whale-alerts');
                const whaleData = await response.json();
                
                if (whaleData.alerts && whaleData.alerts.length > 0) {
                    // Show the most recent 3 alerts
                    const recentAlerts = whaleData.alerts.slice(0, 3);
                    
                    alertsContainer.innerHTML = recentAlerts.map(alert => {
                        const severityClass = alert.severity === 'high' ? 'alert-high' : 'alert-medium';
                        const alertIcon = getAlertIcon(alert.type);
                        
                        return `
                            <div class="insight-card ${severityClass}" style="margin-bottom: 12px; border-left: 4px solid ${getAlertColor(alert.type)};">
                                <div class="insight-header">
                                    <span class="just-in-badge" style="background: ${getAlertColor(alert.type)};">
                                        ${alertIcon} ${alert.type.replace('_', ' ').toUpperCase()}
                                    </span>
                                    <div class="insight-content">
                                        <h4>${alert.ticker}</h4>
                                        <p>${alert.description}</p>
                                        <small style="color: var(--brand-deep); opacity: 0.7;">
                                            ${new Date(alert.timestamp).toLocaleTimeString()}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Update whale alerts count in KPIs
                    document.getElementById('whale-alerts').textContent = whaleData.alerts.length;
                    
                } else {
                    alertsContainer.innerHTML = `
                        <div style="text-align: center; color: var(--brand-deep); opacity: 0.7; padding: 20px;">
                            <p>üîç No whale alerts detected yet</p>
                            <p style="font-size: 0.9em;">Monitoring for volume surges, odds flips, and order book shifts...</p>
                        </div>
                    `;
                    document.getElementById('whale-alerts').textContent = '0';
                }
                
            } catch (error) {
                console.error('Error fetching whale alerts:', error);
                alertsContainer.innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                        <p>‚ö†Ô∏è Error loading whale alerts</p>
                    </div>
                `;
            }
        }

        function getAlertIcon(type) {
            const icons = {
                'volume_surge': 'üìà',
                'odds_flip': '‚ö°',
                'order_book_shift': 'üí∞',
                'high_volume': 'üêã'
            };
            return icons[type] || 'üö®';
        }

        function getAlertColor(type) {
            const colors = {
                'volume_surge': '#e74c3c',      // Red for volume surges
                'odds_flip': '#f39c12',         // Orange for odds changes
                'order_book_shift': '#3498db',   // Blue for order book shifts
                'high_volume': '#1AAE6F'         // Green for high volume
            };
            return colors[type] || '#1AAE6F';
        }

        // Load whale analytics data
        async function loadWhaleAnalytics() {
            try {
                const response = await fetch('/api/whale-analytics');
                const analytics = await response.json();
                
                // Log whale analytics for debugging
                console.log('üêã Whale Analytics:', analytics);
                
            } catch (error) {
                console.error('Error loading whale analytics:', error);
            }
        }

        // Market Cards Functions
        async function loadMarketCards() {
            try {
                const response = await fetch('/api/markets/top5');
                const marketData = await response.json();
                
                if (marketData.markets) {
                    displayMarketCards(marketData.markets);
                }
            } catch (error) {
                console.error('Error loading market cards:', error);
                // Use demo data if API fails
                displayMarketCards(getDemoMarketData());
            }
        }

        function displayMarketCards(markets) {
            const cardsContainer = document.getElementById('markets-cards');
            
            cardsContainer.innerHTML = markets.map(market => createMarketCard(market)).join('');
            
            // Add click listeners for betting buttons
            cardsContainer.querySelectorAll('.bet-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const outcome = btn.classList.contains('yes') ? 'YES' : 'NO';
                    const marketTitle = btn.closest('.market-card').querySelector('.market-question').textContent;
                    showBettingDialog(marketTitle, outcome);
                });
            });
        }

        function createMarketCard(market) {
            const marketIcon = getMarketIconSymbol(market.category);
            const hasMultipleOutcomes = market.outcomes.length > 1;
            
            return `
                <div class="market-card" data-market="${market.id}">
                    <!-- Icon -->
                    <div class="market-icon">
                        ${marketIcon}
                    </div>
                    
                    <div class="market-content">
                        <!-- Title with trending badge -->
                        <div class="market-question">
                            <span>${market.question}</span>
                            ${market.trending ? `
                                <span class="trending-badge">
                                    <span class="trending-dot"></span>
                                    Trending
                                </span>
                            ` : ''}
                        </div>

                        <!-- Option rows -->
                        <div class="space-y-2">
                            ${market.outcomes.map(outcome => `
                                <div class="outcome-item">
                                    <div class="outcome-text">${outcome.description}</div>
                                    <div class="outcome-section">
                                        <div class="probability">${Math.round(outcome.probability * 100)}%</div>
                                        <div class="bet-buttons">
                                            <button class="bet-pill yes" onclick="placeBet('${market.id}', '${outcome.title}', 'YES')">Yes</button>
                                            <button class="bet-pill no" onclick="placeBet('${market.id}', '${outcome.title}', 'NO')">No</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Footer meta -->
                        <div class="market-footer">
                            <div class="volume-info">
                                <span>${formatVolume(market.volume)}</span>
                            </div>
                            <div class="time-info">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="margin-right: 4px;">
                                    <path d="M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>${market.cadence || 'Annually'}</span>
                            </div>
                            <button class="expand-btn" onclick="expandMarket('${market.id}')">+</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMarketIconSymbol(category) {
            const iconMap = {
                crypto: '‚Çø',
                politics: 'üèõÔ∏è',
                economy: 'üí∞',
                sports: '‚öΩ',
                default: '‚Çø'
            };
            
            return iconMap[category.toLowerCase()] || iconMap.default;
        }

        function formatVolume(volume) {
            return new Intl.NumberFormat('en-US', { 
                notation: 'compact',
                compactDisplay: 'short'
            }).format(volume);
        }

        function filterMarkets() {
            const filter = document.getElementById('market-filter').value;
            const cards = document.querySelectorAll('.market-card');
            
            cards.forEach(card => {
                const shouldShow = filter === 'all' || card.dataset[filter] === 'true';
                card.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function refreshMarketData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.classList.add('loading');
            
            loadMarketCards().finally(() => {
                refreshBtn.classList.remove('loading');
            });
        }

        function expandMarket(marketId) {
            console.log('Expanding market:', marketId);
            // TODO: Implement market detail view
        }

        function placeBet(marketId, outcome, betType) {
            alert(`Betting ${betType} on ${outcome}\n\nMarket: ${marketId}\n\nThis is a demo. In a real Kalshi app, this would open the betting interface.`);
        }

        function getDemoMarketData() {
            return [
                {
                    id: 'btc-2024-high',
                    question: 'How high will Bitcoin get this year?',
                    category: 'Crypto',
                    lastUpdate: new Date(),
                    volume: 19842514,
                    cadence: 'Annually',
                    trending: true,
                    outcomes: [
                        {
                            title: 'YES',
                            description: '$130,000 or above',
                            probability: 0.29
                        },
                        {
                            title: 'NO',
                            description: 'Below $130,000',
                            probability: 0.71
                        }
                    ]
                },
                {
                    id: 'eth-flip-2024',
                    question: 'Will ETH flip $5,000 by Q4?',
                    category: 'Crypto',
                    lastUpdate: new Date(),
                    volume: 12500321,
                    cadence: 'Quarterly',
                    trending: false,
                    outcomes: [
                        {
                            title: 'YES',
                            description: '$5,000 or above',
                            probability: 0.41
                        },
                        {
                            title: 'NO',
                            description: 'Below $5,000',
                            probability: 0.59
                        }
                    ]
                },
                {
                    id: 'btc-when-100k',
                    question: 'When will Bitcoin reach $100,000 for the first time?',
                    category: 'Crypto',
                    lastUpdate: new Date(),
                    volume: 8523450,
                    cadence: 'Annually',
                    trending: true,
                    outcomes: [
                        {
                            title: 'YES',
                            description: 'Before June 2025',
                            probability: 0.43
                        }
                    ]
                },
                {
                    id: 'trump-crypto-2024',
                    question: 'Will Donald Trump create a new crypto before election day?',
                    category: 'Politics',
                    lastUpdate: new Date(),
                    volume: 12745632,
                    cadence: 'Election Cycle',
                    trending: true,
                    outcomes: [
                        {
                            title: 'YES',
                            description: 'Trump launches crypto coin',
                            probability: 0.76
                        },
                        {
                            title: 'NO',
                            description: 'No new crypto announced',
                            probability: 0.24
                        }
                    ]
                },
                {
                    id: 'market-cap-4t',
                    question: 'Will crypto market cap exceed $4 trillion by December 2024?',
                    category: 'Crypto',
                    lastUpdate: new Date(),
                    volume: 4321876,
                    cadence: 'Annually',
                    trending: false,
                    outcomes: [
                        {
                            title: 'YES',
                            description: 'Total crypto market > $4T',
                            probability: 0.38
                        }
                    ]
                }
            ];
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function createSparkline(width = 72, height = 24) {
            const path = `M2 ${height - 6} L${width * 0.2} ${height - 12} L${width * 0.35} ${height - 8} L${width * 0.52} ${height - 16} L${width * 0.7} ${height - 10} L${width - 2} ${height - 14}`;
            
            return `
                <div class="sparkline">
                    <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                        <path d="${path}" />
                    </svg>
                </div>
            `;
        }

        // Create charts
        function createCharts() {
            const ctx = document.getElementById('volumeChart');
            if (!ctx) return;

            charts.volume = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Volume ($M)',
                        data: Array.from({length: 24}, () => Math.random() * 10 + 5),
                        borderColor: '#1AAE6F',
                        backgroundColor: 'rgba(26, 174, 111, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(11, 138, 74, 0.1)'
                            },
                            ticks: {
                                color: '#0B8A4A'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(11, 138, 74, 0.1)'
                            },
                            ticks: {
                                color: '#0B8A4A'
                            }
                        }
                    }
                }
            });
        }

        // Show/hide loading state
        function showLoading(isLoading) {
            const elements = document.querySelectorAll('.kpi-card, .market-row, .insight-card');
            elements.forEach(el => {
                el.classList.toggle('loading', isLoading);
            });
        }

        // Refresh data manually
        async function refreshData() {
            try {
                showLoading(true);
                
                // Call backend refresh endpoint
                const response = await fetch(`${API_BASE}/api/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Data refreshed:', data);
                    await fetchAndUpdateData();
                } else {
                    console.error('Refresh failed:', response.status);
                }
                
            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                showLoading(false);
            }
        }

        // Auto-refresh every 2 minutes
        function startAutoRefresh() {
            setInterval(fetchAndUpdateData, 120000); // 2 minutes
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>